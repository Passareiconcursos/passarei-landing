generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id                   String         @id @default(cuid())
  name                 String         @unique
  displayName          String
  description          String
  priceMonthly         Decimal        @db.Decimal(10, 2)
  priceYearly          Decimal?       @db.Decimal(10, 2)
  dailyContentLimit    Int
  dailyCorrectionLimit Int
  dailyEssayLimit      Int
  features             Json
  allowsAffiliate      Boolean        @default(false)
  affiliateCommission  Decimal?       @db.Decimal(5, 2)
  isActive             Boolean        @default(true)
  sortOrder            Int            @default(0)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  subscriptions        Subscription[]

  @@index([name])
  @@index([isActive])
  @@map("Plan")
}

model Subscription {
  id            String             @id @default(cuid())
  userId        String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  startDate     DateTime           @default(now())
  endDate       DateTime?
  paymentMethod String?
  paymentId     String?
  autoRenew     Boolean            @default(true)
  renewalDate   DateTime?
  canceledAt    DateTime?
  cancelReason  String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  plan          Plan               @relation(fields: [planId], references: [id])
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@unique([userId, planId, startDate])
  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("Subscription")
}

model Transaction {
  id               String            @id @default(cuid())
  subscriptionId   String
  amount           Decimal           @db.Decimal(10, 2)
  currency         String            @default("BRL")
  gatewayId        String?
  gatewayName      String
  status           TransactionStatus @default(PENDING)
  paidAt           DateTime?
  affiliateId      String?
  commissionAmount Decimal?          @db.Decimal(10, 2)
  commissionPaid   Boolean           @default(false)
  metadata         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  affiliate        User?             @relation("AffiliateTransactions", fields: [affiliateId], references: [id])
  subscription     Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([gatewayId])
  @@index([affiliateId])
}

model User {
  id                    String             @id @default(cuid())
  phone                 String             @unique
  name                  String?
  email                 String?            @unique
  isActive              Boolean            @default(true)
  isBanned              Boolean            @default(false)
  banReason             String?
  isAffiliate           Boolean            @default(false)
  affiliateCode         String?            @unique
  referredBy            String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  essays                Essay[]
  interactions          Interaction[]
  notifications         Notification[]
  performanceStats      PerformanceStats[]
  questionAttempts      QuestionAttempt[]
  reviews               SpacedReview[]
  studyPlans            StudyPlan[]
  studySessions         StudySession[]
  subscriptions         Subscription[]
  affiliateTransactions Transaction[]      @relation("AffiliateTransactions")
  referrer              User?              @relation("Referrals", fields: [referredBy], references: [affiliateCode])
  referrals             User[]             @relation("Referrals")
  profile               UserProfile?
  progress              UserProgress[]

  @@index([phone])
  @@index([email])
  @@index([isAffiliate])
  @@index([affiliateCode])
  @@index([referredBy])
  @@map("User")
}

model UserProfile {
  id                 String     @id @default(cuid())
  userId             String     @unique
  cargoId            String?
  state              String?
  examDate           DateTime?
  editalUrl          String?
  editalAnalyzed     Boolean    @default(false)
  availableTimeDaily Int
  studyLevel         StudyLevel
  preferredSchedules Json
  strongSubjects     Json?
  weakSubjects       Json?
  allowNotifications Boolean    @default(true)
  allowMotivation    Boolean    @default(true)
  allowAudios        Boolean    @default(false)
  timezone           String     @default("America/Sao_Paulo")
  planJson           Json?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  cargo              Cargo?     @relation(fields: [cargoId], references: [id])
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cargoId])
}

model Cargo {
  id           String         @id @default(cuid())
  name         String         @unique
  displayName  String
  description  String?
  organization String
  state        String?
  level        CargoLevel
  editalUrl    String?
  totalVagas   Int?
  salario      Decimal?       @db.Decimal(10, 2)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  subjects     CargoSubject[]
  userProfiles UserProfile[]

  @@index([name])
  @@index([organization])
  @@index([state])
  @@index([level])
}

model Subject {
  id             String          @id @default(cuid())
  name           String          @unique
  displayName    String
  description    String?
  category       SubjectCategory
  isActive       Boolean         @default(true)
  sortOrder      Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  cargoSubjects  CargoSubject[]
  contents       Content[]
  questions      Question[]
  studyPlanItems StudyPlanItem[]
  topics         Topic[]

  @@index([name])
  @@index([category])
}

model CargoSubject {
  id                String   @id @default(cuid())
  cargoId           String
  subjectId         String
  weight            Decimal? @db.Decimal(5, 2)
  numberOfQuestions Int?
  cargo             Cargo    @relation(fields: [cargoId], references: [id], onDelete: Cascade)
  subject           Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([cargoId, subjectId])
  @@index([cargoId])
  @@index([subjectId])
}

model Topic {
  id          String         @id @default(cuid())
  subjectId   String
  name        String
  description String?
  sortOrder   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  contents    Content[]
  questions   Question[]
  reviews     SpacedReview[]
  subject     Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([subjectId])
}

model Content {
  id                String         @id @default(cuid())
  subjectId         String
  topicId           String?
  title             String
  textContent       String
  difficulty        Difficulty
  wordCount         Int
  estimatedReadTime Int
  audioUrl          String?
  audioDuration     Int?
  isActive          Boolean        @default(true)
  version           Int            @default(1)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subject           Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic             Topic?         @relation(fields: [topicId], references: [id])
  reviews           SpacedReview[]
  userProgress      UserProgress[]

  @@index([subjectId])
  @@index([topicId])
  @@index([difficulty])
}

model Question {
  id                String            @id @default(cuid())
  subjectId         String
  topicId           String?
  statement         String
  questionType      QuestionType
  alternatives      Json?
  correctAnswer     String
  explanation       String
  wrongExplanations Json?
  difficulty        Difficulty
  examBoard         String?
  examYear          Int?
  examName          String?
  tags              Json?
  isActive          Boolean           @default(true)
  timesUsed         Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic             Topic?            @relation(fields: [topicId], references: [id])
  attempts          QuestionAttempt[]
  reviews           SpacedReview[]

  @@index([subjectId])
  @@index([topicId])
  @@index([difficulty])
  @@index([examBoard])
}

model Essay {
  id          String      @id @default(cuid())
  userId      String
  theme       String
  prompt      String
  text        String
  wordCount   Int
  correctedAt DateTime?
  score1      Int?
  score2      Int?
  score3      Int?
  score4      Int?
  score5      Int?
  totalScore  Int?
  feedback    String?
  status      EssayStatus @default(SUBMITTED)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model UserProgress {
  id             String         @id @default(cuid())
  userId         String
  contentId      String
  status         ProgressStatus
  viewCount      Int            @default(0)
  lastViewedAt   DateTime?
  quizAttempts   Int            @default(0)
  quizCorrect    Int            @default(0)
  needsReview    Boolean        @default(false)
  nextReviewAt   DateTime?
  reviewInterval Int?
  easinessFactor Float          @default(2.5)
  hasDoubt       Boolean        @default(false)
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  content        Content        @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@index([status])
  @@index([needsReview])
  @@index([nextReviewAt])
}

model QuestionAttempt {
  id            String      @id @default(cuid())
  userId        String
  questionId    String
  userAnswer    String
  isCorrect     Boolean
  timeSpent     Int?
  attemptType   AttemptType
  reviewAttempt Boolean     @default(false)
  createdAt     DateTime    @default(now())
  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([attemptType])
}

model SpacedReview {
  id             String       @id @default(cuid())
  userId         String
  contentId      String?
  questionId     String?
  topicId        String?
  scheduledFor   DateTime
  completedAt    DateTime?
  reviewNumber   Int          @default(1)
  interval       Int          @default(1)
  easinessFactor Float        @default(2.5)
  quality        Int?
  wasSuccessful  Boolean?
  status         ReviewStatus @default(PENDENTE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  content        Content?     @relation(fields: [contentId], references: [id], onDelete: Cascade)
  question       Question?    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  topic          Topic?       @relation(fields: [topicId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([contentId])
  @@index([questionId])
}

model StudyPlan {
  id            String          @id @default(cuid())
  userId        String
  name          String
  description   String?
  basedOnEdital Boolean         @default(false)
  editalUrl     String?
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean         @default(true)
  isCompleted   Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         StudyPlanItem[]

  @@index([userId])
  @@index([isActive])
}

model StudyPlanItem {
  id                String    @id @default(cuid())
  studyPlanId       String
  subjectId         String
  priority          Int       @default(0)
  sortOrder         Int       @default(0)
  weight            Decimal?  @db.Decimal(5, 2)
  numberOfQuestions Int?
  targetProgress    Int       @default(100)
  currentProgress   Int       @default(0)
  isCompleted       Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  studyPlan         StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)
  subject           Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([studyPlanId])
  @@index([subjectId])
}

model PerformanceStats {
  id                String     @id @default(cuid())
  userId            String
  periodType        PeriodType
  periodStart       DateTime
  periodEnd         DateTime
  daysActive        Int        @default(0)
  contentsStudied   Int        @default(0)
  questionsAnswered Int        @default(0)
  questionsCorrect  Int        @default(0)
  accuracyRate      Float      @default(0)
  totalStudyTime    Int        @default(0)
  currentStreak     Int        @default(0)
  maxStreak         Int        @default(0)
  subjectStats      Json?
  improvement       Float?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodType, periodStart])
  @@index([userId])
  @@index([periodType])
}

model StudySession {
  id                String    @id @default(cuid())
  userId            String
  startTime         DateTime  @default(now())
  endTime           DateTime?
  duration          Int?
  contentsViewed    Int       @default(0)
  questionsAnswered Int       @default(0)
  questionsCorrect  Int       @default(0)
  deviceInfo        Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
}

model Interaction {
  id           String      @id @default(cuid())
  userId       String
  messageType  MessageType
  content      String
  intent       String?
  confidence   Float?
  contextData  Json?
  responseTime Int?
  timestamp    DateTime    @default(now())
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([messageType])
  @@index([timestamp])
}

model Notification {
  id           String             @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  scheduledFor DateTime
  sentAt       DateTime?
  status       NotificationStatus @default(PENDENTE)
  metadata     Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([type])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model UserFeedback {
  id                String       @id @default(cuid())
  userId            String
  type              FeedbackType
  rating            Int?
  comment           String?
  relatedContentId  String?
  relatedQuestionId String?
  createdAt         DateTime     @default(now())

  @@index([userId])
  @@index([type])
}

model Lead {
  id               String     @id @default(cuid())
  name             String
  email            String     @unique
  phone            String
  examType         String
  state            String     @db.VarChar(2)
  status           LeadStatus @default(NOVO)
  source           String?    @default("landing_page")
  notes            String?
  assignedToId     String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  acceptedWhatsApp Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  assignedTo       Admin?     @relation(fields: [assignedToId], references: [id])

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([assignedToId])
}

model Admin {
  id        String         @id @default(cuid())
  email     String         @unique
  password  String
  name      String
  role      AdminRole      @default(ADMIN)
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  sessions  AdminSession[]
  auditLogs AuditLog[]
  leads     Lead[]

  @@index([email])
}

model AdminSession {
  id        String   @id @default(cuid())
  adminId   String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  details   Json?
  createdAt DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  SUSPENDED
  PENDING_PAYMENT
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  REFUNDED
  CANCELED
}

enum StudyLevel {
  INICIANTE
  INTERMEDIARIO
  AVANCADO
}

enum CargoLevel {
  FUNDAMENTAL
  MEDIO
  SUPERIOR
}

enum SubjectCategory {
  LINGUAGENS
  MATEMATICA
  CIENCIAS_HUMANAS
  CIENCIAS_NATUREZA
  DIREITO
  INFORMATICA
  CONHECIMENTOS_GERAIS
  ESPECIFICAS
}

enum Difficulty {
  FACIL
  MEDIO
  DIFICIL
  MUITO_DIFICIL
}

enum QuestionType {
  MULTIPLA_ESCOLHA
  CERTO_ERRADO
}

enum EssayStatus {
  SUBMITTED
  CORRECTED
  PENDING
}

enum ProgressStatus {
  NAO_INICIADO
  EM_PROGRESSO
  CONCLUIDO
  DOMINADO
}

enum AttemptType {
  QUIZ_FIXACAO
  QUESTAO_PRATICA
  SIMULADO
  REVISAO
}

enum ReviewStatus {
  PENDENTE
  CONCLUIDA
  PULADA
  CANCELADA
}

enum PeriodType {
  DIARIO
  SEMANAL
  MENSAL
}

enum MessageType {
  USER_MESSAGE
  BOT_RESPONSE
  SYSTEM
  CONTENT_DELIVERY
  QUESTION_DELIVERY
  REVIEW_PROMPT
  MOTIVATION
  REMINDER
}

enum NotificationType {
  CONTEUDO_DIARIO
  QUESTAO_PRATICA
  REVISAO_ESPACADA
  LEMBRETE_ESTUDO
  MOTIVACAO
  RELATORIO_SEMANAL
  RELATORIO_MENSAL
  EDITAL_ATUALIZADO
}

enum NotificationStatus {
  PENDENTE
  ENVIADA
  ENTREGUE
  LIDA
  FALHOU
  CANCELADA
}

enum FeedbackType {
  CONTEUDO_QUALIDADE
  QUESTAO_QUALIDADE
  EXPLICACAO_CLARA
  DIFICULDADE_ADEQUADA
  EXPERIENCIA_GERAL
  BUG_REPORT
  SUGESTAO
}

enum LeadStatus {
  NOVO
  CONTATADO
  QUALIFICADO
  CONVERTIDO
  PERDIDO
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
  VIEWER
}
