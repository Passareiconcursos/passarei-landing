generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanType {
  FREE
  CALOURO
  VETERANO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  TRIAL
}

model User {
  id                       String         @id @default(uuid())
  telegram_id              String?        @unique
  whatsapp_number          String?        @unique
  name                     String?
  email                    String?
  exam_type                String?
  state                    String?
  cargo                    String?
  nivel                    String?
  facilidades              String[]
  dificuldades             String[]
  tempo_disponivel         String?
  horario_estudo           String?
  
  plan_type                PlanType       @default(FREE)
  subscription_id          String?        @unique
  
  daily_content_count      Int            @default(0)
  daily_corrections_count  Int            @default(0)
  daily_essays_count       Int            @default(0)
  last_content_date        DateTime?      @default(now())  // ✅ CORRIGIDO: DateTime ao invés de Date
  
  total_questions_answered Int            @default(0)
  correct_answers          Int            @default(0)
  wrong_answers            Int            @default(0)
  total_study_time         Int            @default(0)
  
  is_premium               Boolean        @default(false)
  premium_until            DateTime?
  
  referral_code            String?        @unique
  referred_by              String?
  
  created_at               DateTime       @default(now())
  updated_at               DateTime       @updatedAt
  onboarding_completed_at  DateTime?
  
  subscription             Subscription?  @relation("UserSubscription")
  essay_corrections        EssayCorrection[]
  referrals_made           Referral[]     @relation("Referrer")
  referrals_received       Referral[]     @relation("Referred")
  affiliate_commissions    AffiliateCommission[]
}

model Plan {
  id                        String   @id @default(uuid())
  type                      PlanType @unique
  name                      String
  price_monthly             Decimal  @db.Decimal(10, 2)
  price_annual              Decimal? @db.Decimal(10, 2)
  
  daily_materials_limit     Int
  daily_corrections_limit   Int
  daily_essay_corrections   Int
  
  extra_essay_price         Decimal? @db.Decimal(10, 2)
  
  has_study_plan            Boolean  @default(false)
  has_monthly_simulados     Boolean  @default(false)
  has_unlimited_simulados   Boolean  @default(false)
  support_sla_hours         Int
  
  affiliate_commission_rate Decimal? @db.Decimal(5, 2)
  
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  
  subscriptions             Subscription[]
}

model Subscription {
  id                          String             @id @default(uuid())
  user_id                     String             @unique
  plan_id                     String
  
  status                      SubscriptionStatus @default(ACTIVE)
  
  started_at                  DateTime           @default(now())
  current_period_start        DateTime           @default(now())
  current_period_end          DateTime
  canceled_at                 DateTime?
  guarantee_expires_at        DateTime
  
  mercado_pago_subscription_id String?           @unique
  mercado_pago_payment_id     String?
  payment_method              String?
  
  created_at                  DateTime           @default(now())
  updated_at                  DateTime           @updatedAt
  
  user                        User               @relation("UserSubscription", fields: [user_id], references: [id])
  plan                        Plan               @relation(fields: [plan_id], references: [id])
  
  @@index([user_id])
  @@index([plan_id])
}

model EssayCorrection {
  id                 String    @id @default(uuid())
  user_id            String
  
  is_free            Boolean   @default(false)
  price_paid         Decimal?  @db.Decimal(10, 2)
  
  original_text      String    @db.Text
  image_url          String?
  
  score              Int?
  detailed_feedback  String?   @db.Text
  strengths          String[]
  improvements       String[]
  
  ai_cost            Decimal   @db.Decimal(10, 4)
  
  status             String    @default("PENDING")
  
  created_at         DateTime  @default(now())
  completed_at       DateTime?
  
  user               User      @relation(fields: [user_id], references: [id])
  
  @@index([user_id])
  @@index([created_at])
}

model Referral {
  id              String    @id @default(uuid())
  referrer_id     String
  referred_id     String
  
  program_type    String
  status          String    @default("PENDING")
  
  qualified_at    DateTime?
  rewarded_at     DateTime?
  
  created_at      DateTime  @default(now())
  
  referrer        User      @relation("Referrer", fields: [referrer_id], references: [id])
  referred        User      @relation("Referred", fields: [referred_id], references: [id])
  
  @@index([referrer_id])
  @@index([referred_id])
  @@index([status])
}

model AffiliateCommission {
  id                 String    @id @default(uuid())
  affiliate_id       String
  referral_id        String
  
  reference_month    String
  commission_amount  Decimal   @db.Decimal(10, 2)
  
  status             String    @default("PENDING")
  paid_at            DateTime?
  pix_key            String?
  
  created_at         DateTime  @default(now())
  
  affiliate          User      @relation(fields: [affiliate_id], references: [id])
  
  @@index([affiliate_id])
  @@index([status])
  @@index([reference_month])
}

model AIGeneratedContent {
  id         String   @id @default(uuid())
  exam_type  String
  title      String
  definition String   @db.Text
  key_points String   @db.Text
  example    String   @db.Text
  tip        String   @db.Text
  created_at DateTime @default(now())
  
  @@index([exam_type])
}

model ExamSubject {
  id           String   @id @default(uuid())
  exam_type    String
  state        String   @default("ALL_STATES")
  cargo        String
  subject_name String
  weight       Int      @default(3)
  is_reference Boolean  @default(false)
  created_at   DateTime @default(now())
  
  @@index([exam_type, cargo, state])
}
